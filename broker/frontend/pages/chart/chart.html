<!DOCTYPE html>
<html lang="fa" dir="rtl"></html>

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>tabe nemoodarha</title>
    <script src="https://code.highcharts.com/stock/11.2.0/highstock.js"></script>

    <!-- Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ -->
    <script src="https://code.highcharts.com/stock/11.2.0/modules/data.js"></script>
    <script src="https://code.highcharts.com/stock/11.2.0/modules/drag-panes.js"></script>
    <script src="https://code.highcharts.com/stock/11.2.0/modules/annotations.js"></script>
    <script src="https://code.highcharts.com/stock/11.2.0/modules/annotations-advanced.js"></script>
    <script src="https://code.highcharts.com/stock/11.2.0/modules/price-indicator.js"></script>
    <script src="https://code.highcharts.com/stock/11.2.0/modules/full-screen.js"></script>
    <script src="https://code.highcharts.com/stock/11.2.0/modules/stock-tools.js"></script>
    <script src="https://code.highcharts.com/stock/11.2.0/indicators/indicators-all.js"></script>
    <script src="https://code.highcharts.com/stock/11.2.0/modules/accessibility.js"></script>

    <!-- Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ ØµØ§Ø¯Ø±Ø§Øª -->
    <script src="https://code.highcharts.com/stock/11.2.0/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/11.2.0/modules/export-data.js"></script>

    <!-- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ -->
    <link rel="stylesheet" href="https://code.highcharts.com/11.2.0/css/stocktools/gui.css">
    <link rel="stylesheet" href="https://code.highcharts.com/11.2.0/css/annotations/popup.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.2/build/moment-jalaali.js"></script>

    <style>
      .highcharts-container,
      .highcharts-stocktools-wrapper,
      .highcharts-bindings-wrapper {
          pointer-events: auto !important;
          z-index: 2000 !important;
      }
      .highcharts-menu-wrapper,
      .highcharts-menu {
          z-index: 2010 !important;
      }
      #chartContainer {
          position: relative;
          z-index: 1000 !important;
      }
    </style>

  </head>
  <body>
    <div id="toppest-nav">
        <div id="right-toppest-nav">
            <ul class="main-menu-right">
                <li class="main-menu-right-items"><a class="linkmenu" href="/reports/reports.html">Ú¯Ø²Ø§Ø±Ø´Ø§Øª</a></li>
                <li class="main-menu-right-items"><a class="linkmenu" href="/raw_data/data.html">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù…</a></li>
                <li class="main-menu-right-items"><a class="linkmenu" href="/arze/arze.html">Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø¹Ø±Ø¶Ù‡</a></li>
                <li class="main-menu-right-items"><a class="linkmenu active" href="/chart/chart.html">Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</a></li>
            </ul>
        </div>
        <div id="left-toppest-nav">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</div>
        
    </div>
    <div class="samane-tahlil">
      <p class="matnesamane">Ø³Ø§Ù…Ø§Ù†Ù‡ ØªØ­Ù„ÛŒÙ„ Ø¨ÙˆØ±Ø³ Ú©Ø§Ù„Ø§->Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</p>
    </div>
    <div class="main-container">
      <div class="r-part">
        <div class="containernamefilter">
        <h3 class="filternamechoose">Ø§Ù†ØªØ®Ø§Ø¨ ÙÛŒÙ„ØªØ±Ù‡Ø§</h3>
        </div>

        <div class="filters">
          <div class="filter-group">
            <div class="filter-item">
              <label></label>
              <select id="marketFilter">
                <option class="filterstyleset" value=""> ØªØ§Ù„Ø§Ø±</option>
              </select>
            </div>
  
            <div class="filter-item">
              <label></label>
              <select id="producerFilter">
                <option class="filterstyleset" value=""> ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡</option>
              </select>
            </div>
  
            <div class="filter-item">
              <label></label>
              <select id="productFilter">
                <option class="filterstyleset" value=""> Ù…Ø­ØµÙˆÙ„</option>
              </select>
            </div>
  
            <div class="filter-item">
              <label></label>
              <select id="contractTypeFilter">
                <option class="filterstyleset" value=""> Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</option>
              </select>
            </div>
  
            <div class="filter-item">
              <label></label>
              <select id="chartTypeFilter">
                <option class="filterstyleset" value="candlestick">Ø´Ù…Ø¹ÛŒ</option>
                <option value="line">Ø®Ø·ÛŒ (Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ÙˆØ²Ù†ÛŒ)</option>
              </select>
            </div>
          </div>

      </div>
      <div class="filter-actions">
        <button id="applyFilters" "> Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±Ù‡Ø§ </button>
      </div>
    </div>
    <div class="l-part"> 
        <div class="selected-filters">
            <h3>ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</h3>
            <div id="filterSummary"></div>
        </div>
        <p class="resu">Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬</p>
        <div class="header-info">
          <p class="num1">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="lastUpdate"></span></p>
          <p class="num2">Ú©Ø§Ø±Ø¨Ø±: <span id="currentUser"></span></p>
        </div>
       
     

      <div class="showingTables">
      <p class="tblshow">Ø¨Ø®Ø´ Ù†Ù…ÙˆØ¯Ø§Ø±</p>
      <div id="stockToolsDiv"></div>
      <div id="chartContainer"></div>
      </div>

      <button id="toggleTable" class="btn1 infoshowbtn">Ø¨Ø®Ø´ Ø¬Ø¯ÙˆÙ„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</button>
      <div
        id="dataTableContainer"
        class="data-table-container"
        style="display: none"
      ></div>
    </div>
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
        <span class="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
    </div>

    <!-- 
<!--
    <button id="toggleTable" class="btn">Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</button>
    <div id="dataTableContainer" class="data-table-container" style="display: none;"></div>
  </div>
    </div> -->
    
    <!-- Ù¾Ø§Ø±Øª Ø§ØµÙ„ÛŒ-->
    <script>
      // ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ
      let chart;
      let rawData = [];
      const currentUser = "AmirMohammadSalimi";
      const currentDateTime = "2025-02-21 07:38:39";
      
      let currentFilters = {
        market: "",
        producer: "",
        product: "",
        contractType: "",
        chartType: "candlestick"
      };

      let marketData = {
        producers: [],
        products: [],
        contractTypes: []
      };

      // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
    function showLoading() {
        const loadingElement = document.querySelector('.loading-overlay');
        if (loadingElement) {
            loadingElement.style.display = 'flex';
        } else {
            console.warn('Loading element not found');
        }
    }

    function hideLoading() {
        const loadingElement = document.querySelector('.loading-overlay');
        if (loadingElement) {
            loadingElement.style.display = 'none';
        } else {
            console.warn('Loading element not found');
        }
    }

      function updateLastUpdateTime() {
        document.getElementById("lastUpdate").textContent = new Date(currentDateTime).toLocaleString("fa-IR");
        document.getElementById("currentUser").textContent = currentUser;
      }

      function removeDuplicates(array) {
        if (!Array.isArray(array)) return [];
        return [...new Set(array)].filter(item => item != null && item !== undefined && item !== "");
      }

      // ØªÙ†Ø¸ÛŒÙ… Select2
      function initializeSelect2() {
        $("#marketFilter, #producerFilter, #productFilter, #contractTypeFilter, #chartTypeFilter").select2({
            dir: "rtl",
            width: "220px", /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª */
            language: {
            noResults: function() {
                return "Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯";
            }
          }
        });
      }

      // Ù…Ø¯ÛŒØ±ÛŒØª ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ§Ø¨Ø³ØªÙ‡
      async function loadMarkets() {
        try {
            showLoading();
            const response = await fetch("http://185.213.164.220:8000/markets/data?unique=true");
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data.markets && Array.isArray(data.markets)) {
                const uniqueMarkets = removeDuplicates(data.markets);
                const marketSelect = $("#marketFilter");
                marketSelect.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ù„Ø§Ø±</option>');

                uniqueMarkets.forEach(market => {
                    marketSelect.append(new Option(market, market));
                });
            }
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØªØ§Ù„Ø§Ø±Ù‡Ø§:", error);
            showError("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØªØ§Ù„Ø§Ø±Ù‡Ø§. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.");
        } finally {
            hideLoading();
        }
    }
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        
        // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¨Ø¹Ø¯ Ø§Ø² 5 Ø«Ø§Ù†ÛŒÙ‡
        setTimeout(() => {
            errorDiv.remove();
        }, 5000);
    }

      async function handleMarketChange() {
        const selectedMarket = $("#marketFilter").val();
        currentFilters.market = selectedMarket;

        if (!selectedMarket) {
          resetFilters();
          return;
        }

        showLoading();
        try {
          const response = await fetch(`http://185.213.164.220:8000/markets/data?market=${encodeURIComponent(selectedMarket)}&unique=true`);
          const data = await response.json();

          if (data) {
            marketData.producers = removeDuplicates(data.producers || []);
            marketData.products = [];
            marketData.contractTypes = [];

            updateProducerSelect();
            updateProductSelect();
            updateContractTypeSelect();
          }
        } catch (error) {
          console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ù„Ø§Ø±:", error);
        } finally {
          hideLoading();
        }
      }

      async function handleProducerChange() {
        const selectedProducer = $("#producerFilter").val();
        currentFilters.producer = selectedProducer;

        if (!selectedProducer) {
            if (currentFilters.market) {
                const url = new URL("http://185.213.164.220:8000/markets/data");
                url.searchParams.append("market", currentFilters.market);
                url.searchParams.append("unique", "true");
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data && data.product_names) { // ØªØºÛŒÛŒØ± Ø§Ø² products Ø¨Ù‡ product_names
                        marketData.products = removeDuplicates(data.product_names);
                    }
                } catch (error) {
                    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª ØªØ§Ù„Ø§Ø±:", error);
                }
            } else {
                marketData.products = [];
            }
            marketData.contractTypes = [];
            updateProductSelect();
            updateContractTypeSelect();
            return;
        }

        showLoading();
        try {
            const url = new URL("http://185.213.164.220:8000/markets/data");
            if (currentFilters.market) {
                url.searchParams.append("market", currentFilters.market);
            }
            url.searchParams.append("producer", selectedProducer);
            url.searchParams.append("unique", "true");

            console.log("Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡:", url.toString());

            const response = await fetch(url);
            const data = await response.json();

            console.log("Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡:", data);

            if (data) {
                // ØªØºÛŒÛŒØ± Ø§Ø² products Ø¨Ù‡ product_names
                if (data.product_names) {
                    marketData.products = removeDuplicates(data.product_names);
                    console.log("Ù…Ø­ØµÙˆÙ„Ø§Øª ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡:", marketData.products);
                } else {
                    console.warn("Ù‡ÛŒÚ† Ù…Ø­ØµÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯");
                    marketData.products = [];
                }
                
                marketData.contractTypes = [];
                updateProductSelect();
                updateContractTypeSelect();
            }
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡:", error);
            marketData.products = [];
            marketData.contractTypes = [];
            updateProductSelect();
            updateContractTypeSelect();
        } finally {
            hideLoading();
        }
    }

    async function handleProductChange() {
        const selectedProduct = $("#productFilter").val();
        currentFilters.product = selectedProduct;

        if (!selectedProduct) {
            marketData.contractTypes = [];
            updateContractTypeSelect();
            return;
        }

        showLoading();
        try {
            const url = new URL("http://185.213.164.220:8000/markets/data");
            if (currentFilters.market) url.searchParams.append("market", currentFilters.market);
            if (currentFilters.producer) url.searchParams.append("producer", currentFilters.producer);
            url.searchParams.append("product_name", selectedProduct);
            url.searchParams.append("unique", "true");

            console.log("Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø¨Ø±Ø§ÛŒ Ù…Ø­ØµÙˆÙ„:", url.toString());

            const response = await fetch(url);
            const data = await response.json();

            console.log("Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­ØµÙˆÙ„:", data);

            if (data && data.contract_types) {
                marketData.contractTypes = removeDuplicates(data.contract_types);
                console.log("Ø§Ù†ÙˆØ§Ø¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡:", marketData.contractTypes);
            } else {
                console.warn("Ù‡ÛŒÚ† Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯");
                marketData.contractTypes = [];
            }
            
            updateContractTypeSelect();
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± ÙÛŒÙ„ØªØ± Ù…Ø­ØµÙˆÙ„Ø§Øª:", error);
            marketData.contractTypes = [];
            updateContractTypeSelect();
        } finally {
            hideLoading();
        }
    }

    async function handleContractTypeChange() {
        const selectedContractType = $("#contractTypeFilter").val();
        currentFilters.contractType = selectedContractType;
    }

    function updateProducerSelect(selectedValue = "") {
        const producerSelect = $("#producerFilter");
        producerSelect.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡</option>');

        if (marketData.producers && marketData.producers.length) {
            marketData.producers.forEach(producer => {
                if (producer) {
                    producerSelect.append(new Option(producer, producer));
                }
            });

            if (selectedValue && marketData.producers.includes(selectedValue)) {
                producerSelect.val(selectedValue);
            }
        }
        producerSelect.trigger("change");
    }

    function updateProductSelect(selectedValue = "") {
        const productSelect = $("#productFilter");
        
        console.log("Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø§:", marketData.products);
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú¯Ø²ÛŒÙ†Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        productSelect.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ØµÙˆÙ„</option>');

        // Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯
        if (marketData.products && marketData.products.length > 0) {
            marketData.products.forEach(product => {
                if (product) {
                    productSelect.append(new Option(product, product));
                }
            });

            // Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª
            if (selectedValue && marketData.products.includes(selectedValue)) {
                productSelect.val(selectedValue);
            }
        }

        // ØªØ±ÛŒÚ¯Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯ change Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
        productSelect.trigger("change");
        
        // Ø±ÛŒÙØ±Ø´ Select2
        productSelect.select2({
            dir: "rtl",
            language: {
                noResults: function() {
                    return "Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯";
                }
            }
        });
    }

    function updateContractTypeSelect(selectedValue = "") {
        const contractTypeSelect = $("#contractTypeFilter");
        contractTypeSelect.empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</option>');

        if (marketData.contractTypes && marketData.contractTypes.length) {
            marketData.contractTypes.forEach(contractType => {
                if (contractType) {
                    contractTypeSelect.append(new Option(contractType, contractType));
                }
            });

            if (selectedValue && marketData.contractTypes.includes(selectedValue)) {
                contractTypeSelect.val(selectedValue);
            }
        }
        contractTypeSelect.trigger("change");
    }

    function resetFilters() {
        $("#producerFilter").empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡</option>').trigger("change");
        $("#productFilter").empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ØµÙˆÙ„</option>').trigger("change");
        $("#contractTypeFilter").empty().append('<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</option>').trigger("change");
        currentFilters = {
            market: "",
            producer: "",
            product: "",
            contractType: "",
            chartType: currentFilters.chartType
        };
        rawData = [];
    }

    function handleChartTypeChange() {
        currentFilters.chartType = $("#chartTypeFilter").val();
        if (rawData.length > 0) {
            updateChart(rawData);
        }
    }

    function processChartData(data) {
        if (!Array.isArray(data) || data.length === 0) {
            return { ohlc: [], volume: [] };
        }

        const groupedData = data.reduce((acc, item) => {
            if (!item.transaction_date) return acc;
            const date = new Date(item.transaction_date);
            const dateKey = Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());

            if (!acc[dateKey]) {
                acc[dateKey] = {
                    timestamp: dateKey,
                    data: []
                };
            }
            acc[dateKey].data.push(item);
            return acc;
        }, {});

        const ohlc = [];
        const volume = [];

        Object.values(groupedData).forEach(group => {
            let dayData = group.data;
            let openPrice = parseFloat(dayData[0].lowest_price) || parseFloat(dayData[0].base_price);
            let highPrice = Math.max(...dayData.map(item => parseFloat(item.highest_price) || parseFloat(item.base_price)));
            let lowPrice = Math.min(...dayData.map(item => parseFloat(item.base_price)));
            let closePrice = parseFloat(dayData[dayData.length - 1].highest_price) || parseFloat(dayData[dayData.length - 1].base_price);
            let volumeSum = dayData.reduce((sum, item) => sum + (parseFloat(item.contract_volume) || 0), 0);

            ohlc.push([
                group.timestamp,
                openPrice,
                highPrice,
                lowPrice,
                closePrice
            ]);

            volume.push([
                group.timestamp,
                volumeSum
            ]);
        });

        return {
            ohlc: ohlc.sort((a, b) => a[0] - b[0]),
            volume: volume.sort((a, b) => a[0] - b[0])
        };
    }

    function createChart() {
      Highcharts.setOptions({
          // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§
          colors: [
              '#2196F3', // Ø¢Ø¨ÛŒ
              '#4CAF50', // Ø³Ø¨Ø²
              '#FFC107', // Ù†Ø§Ø±Ù†Ø¬ÛŒ
              '#E91E63', // ØµÙˆØ±ØªÛŒ
              '#9C27B0', // Ø¨Ù†ÙØ´
              '#00BCD4', // Ø¢Ø¨ÛŒ Ø±ÙˆØ´Ù†
              '#FF5722', // Ù†Ø§Ø±Ù†Ø¬ÛŒ Ù¾Ø±Ø±Ù†Ú¯
              '#795548'  // Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ
          ],
          chart: {
              style: {
                  fontFamily: 'Vazirmatn'
              }
          }
      });

      chart = Highcharts.stockChart('chartContainer', {
          chart: {
              backgroundColor: {
                  linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
                  stops: [
                      [0, '#f8f9fa'],
                      [1, '#ffffff']
                  ]
              },
              style: {
                  fontFamily: 'Vazirmatn'
              },
              events: {
                  load: function() {
                      //this.showLoading('');
                  }
              },
              borderRadius: 8,
              plotBorderColor: '#e8e8e8',
              plotBorderWidth: 1
          },

          // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø±
          navigator: {
              enabled: true,
              outlineColor: '#e8e8e8',
              outlineWidth: 1,
              handles: {
                  backgroundColor: '#fff',
                  borderColor: '#2196F3'
              },
              series: {
                  color: '#90CAF9',
                  lineWidth: 1
              }
          },

          // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³Ú©Ø±ÙˆÙ„â€ŒØ¨Ø§Ø±
          scrollbar: {
              enabled: true,
              barBackgroundColor: '#e8e8e8',
              barBorderRadius: 4,
              barBorderWidth: 0,
              buttonBackgroundColor: '#e8e8e8',
              buttonBorderWidth: 0,
              buttonBorderRadius: 4,
              trackBackgroundColor: '#f8f9fa',
              trackBorderWidth: 0,
              trackBorderRadius: 4
          },

          // Ø§Ù†ØªØ®Ø§Ø¨â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ
          rangeSelector: {
              buttonTheme: {
                  fill: '#fff',
                  stroke: '#e8e8e8',
                  'stroke-width': 1,
                  style: {
                      color: '#666'
                  },
                  states: {
                      hover: {
                          fill: '#2196F3',
                          style: {
                              color: 'white'
                          }
                      },
                      select: {
                          fill: '#2196F3',
                          style: {
                              color: 'white'
                          }
                      }
                  }
              },
              inputBoxBorderColor: '#e8e8e8',
              inputBoxHeight: 30,
              inputStyle: {
                  color: '#666',
                  fontWeight: 'bold'
              },
              labelStyle: {
                  color: '#666',
                  fontWeight: 'bold'
              },
              selected: 5 // Ú¯Ø²ÛŒÙ†Ù‡ all (Ø¢Ø®Ø±ÛŒÙ† Ø¯Ú©Ù…Ù‡)
          },

          // Ø¹Ù†ÙˆØ§Ù† Ù†Ù…ÙˆØ¯Ø§Ø±
          title: {
              text: 'Ù†Ù…ÙˆØ¯Ø§Ø± Ù‚ÛŒÙ…Øª Ùˆ Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
              style: {
                  fontSize: '18px',
                  fontWeight: 'bold',
                  color: '#333'
              }
          },

          // ØªÙˆÙ„ØªÛŒÙ¾
          tooltip: {
              split: true,
              useHTML: true,
              backgroundColor: 'rgba(255, 255, 255, 0.95)',
              borderWidth: 1,
              borderColor: '#e8e8e8',
              borderRadius: 8,
              shadow: true,
              style: {
                  padding: '10px'
              },
              formatter: function() {
                  if (!this.points) return false;
                  // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
                  var shamsiDate = moment(this.x).locale('fa').format('jYYYY/jMM/jDD');
                  let tooltipText = `
                      <div style="direction: rtl; text-align: right; font-family: Vazirmatn;">
                          <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #333">
                              ${shamsiDate}
                          </div>`;
                  this.points.forEach(point => {
                      if (point.series.name === 'Ù‚ÛŒÙ…Øª') {
                          tooltipText += `
                              <div style="margin-bottom: 5px;">
                                  <span style="color: ${point.color}">â—</span>
                                  <span style="color: #666">Ù‚ÛŒÙ…Øª Ø¨Ø§Ø²:</span>
                                  <span style="font-weight: bold">${Highcharts.numberFormat(point.point.open, 0)}</span>
                              </div>
                              <div style="margin-bottom: 5px;">
                                  <span style="color: ${point.color}">â—</span>
                                  <span style="color: #666">Ø¨ÛŒØ´ØªØ±ÛŒÙ†:</span>
                                  <span style="font-weight: bold">${Highcharts.numberFormat(point.point.high, 0)}</span>
                              </div>
                              <div style="margin-bottom: 5px;">
                                  <span style="color: ${point.color}">â—</span>
                                  <span style="color: #666">Ú©Ù…ØªØ±ÛŒÙ†:</span>
                                  <span style="font-weight: bold">${Highcharts.numberFormat(point.point.low, 0)}</span>
                              </div>
                              <div style="margin-bottom: 5px;">
                                  <span style="color: ${point.color}">â—</span>
                                  <span style="color: #666">Ù‚ÛŒÙ…Øª Ø¨Ø³ØªÙ‡:</span>
                                  <span style="font-weight: bold">${Highcharts.numberFormat(point.point.close, 0)}</span>
                              </div>`;
                      } else if (point.series.name === 'Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª') {
                          tooltipText += `
                              <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e8e8e8;">
                                  <span style="color: ${point.color}">â—</span>
                                  <span style="color: #666">Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª:</span>
                                  <span style="font-weight: bold">${Highcharts.numberFormat(point.y, 0)}</span>
                              </div>`;
                      }
                  });
                  tooltipText += '</div>';
                  return tooltipText;
              }
          },

          // Ù…Ø­ÙˆØ±Ù‡Ø§
          yAxis: [{
              labels: {
                  align: 'right',
                  x: -3,
                  style: {
                      color: '#666'
                  }
              },
              title: {
                  text: 'Ù‚ÛŒÙ…Øª',
                  style: {
                      color: '#666',
                      fontWeight: 'bold'
                  }
              },
              height: '60%',
              lineWidth: 1,
              gridLineColor: '#f0f0f0',
              resize: {
                  enabled: true
              }
          }, {
              labels: {
                  align: 'right',
                  x: -3,
                  style: {
                      color: '#666'
                  }
              },
              title: {
                  text: 'Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
                  style: {
                      color: '#666',
                      fontWeight: 'bold'
                  }
              },
              top: '65%',
              height: '35%',
              offset: 0,
              lineWidth: 1,
              gridLineColor: '#f0f0f0'
          }],

          // Ø³Ø±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡
          series: [{
              type: 'candlestick',
              name: 'Ù‚ÛŒÙ…Øª',
              id: 'main-series',
              data: [],
              color: '#ef5350', // Ø±Ù†Ú¯ Ø´Ù…Ø¹ Ù†Ø²ÙˆÙ„ÛŒ
              upColor: '#26a69a', // Ø±Ù†Ú¯ Ø´Ù…Ø¹ ØµØ¹ÙˆØ¯ÛŒ
              lineColor: '#ef5350', // Ø±Ù†Ú¯ Ø®Ø· Ø´Ù…Ø¹ Ù†Ø²ÙˆÙ„ÛŒ
              upLineColor: '#26a69a', // Ø±Ù†Ú¯ Ø®Ø· Ø´Ù…Ø¹ ØµØ¹ÙˆØ¯ÛŒ
              dataGrouping: {
                  enabled: false
              }
          }, {
              type: 'column',
              name: 'Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
              data: [],
              yAxis: 1,
              color: 'rgba(33, 150, 243, 0.5)',
              dataGrouping: {
                  enabled: false
              }
          }],

          // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ÛŒ
          stockTools: {
            gui: {
                enabled: true,
                container: 'stockToolsDiv',
                buttons: [
                    'indicators',
                    'separator',
                    'simpleShapes',
                    'lines',
                    'crookedLines',
                    'measure',
                    'advanced',
                    'toggleAnnotations',
                    'separator',
                    'verticalLabels',
                    'flags',
                    'separator',
                    'zoomChange',
                    'fullScreen',
                    'typeChange',
                    'separator',
                    'currentPriceIndicator',
                    'saveChart'
                ],
                definitions: {
                    button: {
                        width: 30,
                        height: 30,
                        padding: 5
                    }
                }
            }
        },

          // Ùˆ Ø§ÛŒÙ† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯Ø±Ø³Øª Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§
          zoomType: 'x',
          panning: {
              enabled: true,
              type: 'x'
          },

          // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ
          responsive: {
              rules: [{
                  condition: {
                      maxWidth: 800
                  },
                  chartOptions: {
                      rangeSelector: {
                          inputEnabled: false
                      }
                  }
              }]
          },

          // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú©Ø±Ø¯ÛŒØª Highcharts
          credits: {
              enabled: false
          }
      });
  }

    function updateChart(data) {
        if (!chart) return;

        const { ohlc, volume } = processChartData(data);
        
        if (currentFilters.chartType === 'candlestick') {
            chart.series[0].update({
                type: 'candlestick',
                data: ohlc
            }, false);
        } else {
            chart.series[0].update({
                type: 'line',
                data: ohlc.map(point => [point[0], point[4]]) // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒØ§Ù†ÛŒ
            }, false);
        }
        
        chart.series[1].setData(volume, false);
        chart.redraw();
        chart.hideLoading(); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ø®Ø·
    }

    function showDataTable(data) {
        const tableContainer = document.getElementById("dataTableContainer");
        
        if (!data || data.length === 0) {
            tableContainer.style.display = "none";
            return;
        }

        tableContainer.style.display = "block";
        document.getElementById("toggleTable").textContent = "Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª";

        tableContainer.innerHTML = `
            <h3 class="table-title">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
            <div class="table-wrapper">
                <table id="dataTable" class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</th>
                            <th>Ù†Ù…Ø§Ø¯</th>
                            <th>ØªØ§Ù„Ø§Ø±</th>
                            <th>ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡</th>
                            <th>Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</th>
                            <th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ÙˆØ²Ù†ÛŒ Ù‚ÛŒÙ…Øª</th>
                            <th>Ø§Ø±Ø²Ø´ Ù…Ø¹Ø§Ù…Ù„Ù‡</th>
                            <th>Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒØ§Ù†ÛŒ</th>
                            <th>Ú©Ù…ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª</th>
                            <th>Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª</th>
                            <th>Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡</th>
                            <th>Ø­Ø¬Ù… Ø¹Ø±Ø¶Ù‡</th>
                            <th>Ø­Ø¬Ù… ØªÙ‚Ø§Ø¶Ø§</th>
                            <th>Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ù‡</th>
                            <th>ÙˆØ§Ø­Ø¯</th>
                            <th>ØªØ§Ø±ÛŒØ® Ù…Ø¹Ø§Ù…Ù„Ù‡</th>
                            <th>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„</th>
                            <th>Ù…Ø­Ù„ ØªØ­ÙˆÛŒÙ„</th>
                            <th>Ø¹Ø±Ø¶Ù‡â€ŒÚ©Ù†Ù†Ø¯Ù‡</th>
                            <th>ØªØ§Ø±ÛŒØ® ØªØ³ÙˆÛŒÙ‡</th>
                            <th>Ú©Ø§Ø±Ú¯Ø²Ø§Ø±</th>
                            <th>Ø±ÙˆØ´ Ø¹Ø±Ø¶Ù‡</th>
                            <th>Ø±ÙˆØ´ Ø®Ø±ÛŒØ¯</th>
                            <th>Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</th>
                            <th>Ù†ÙˆØ¹ ØªØ³ÙˆÛŒÙ‡</th>
                            <th>ÙˆØ§Ø­Ø¯ Ù¾ÙˆÙ„</th>
                            <th>Ú©Ø¯ Ø¹Ø±Ø¶Ù‡</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        `;

        const table = $('#dataTable').DataTable({
            data: data,
            columns: [
                { data: 'id', title: 'ID' },
                { data: 'product_name', title: 'Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„' },
                { data: 'symbol', title: 'Ù†Ù…Ø§Ø¯' },
                { data: 'market', title: 'ØªØ§Ù„Ø§Ø±' },
                { data: 'producer', title: 'ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡' },
                { data: 'contract_type', title: 'Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯' },
                { 
                    data: 'weighted_average_price', 
                    title: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ÙˆØ²Ù†ÛŒ Ù‚ÛŒÙ…Øª',
                    render: function(data) {
                        return data === null ? '---' : data;
                    }
                },
                { 
                    data: 'transaction_value', 
                    title: 'Ø§Ø±Ø²Ø´ Ù…Ø¹Ø§Ù…Ù„Ù‡',
                    render: function(data) {
                        return data === 0 ? '---' : new Intl.NumberFormat('fa-IR').format(data);
                    }
                },
                { 
                    data: 'closing_price', 
                    title: 'Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒØ§Ù†ÛŒ',
                    render: function(data) {
                        return data === null ? '---' : new Intl.NumberFormat('fa-IR').format(data);
                    }
                },
                { 
                    data: 'lowest_price', 
                    title: 'Ú©Ù…ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª',
                    render: function(data) {
                        return data === null ? '---' : new Intl.NumberFormat('fa-IR').format(data);
                    }
                },
                { 
                    data: 'highest_price', 
                    title: 'Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª',
                    render: function(data) {
                        return data === null ? '---' : new Intl.NumberFormat('fa-IR').format(data);
                    }
                },
                { 
                    data: 'base_price', 
                    title: 'Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡',
                    render: function(data) {
                        return new Intl.NumberFormat('fa-IR').format(data);
                    }
                },
                { data: 'supply_volume', title: 'Ø­Ø¬Ù… Ø¹Ø±Ø¶Ù‡' },
                { data: 'demand_volume', title: 'Ø­Ø¬Ù… ØªÙ‚Ø§Ø¶Ø§' },
                { data: 'contract_volume', title: 'Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ù‡' },
                { data: 'unit', title: 'ÙˆØ§Ø­Ø¯' },
                { 
                    data: 'transaction_date', 
                    title: 'ØªØ§Ø±ÛŒØ® Ù…Ø¹Ø§Ù…Ù„Ù‡',
                    render: function(data) {
                        return new Date(data).toLocaleDateString('fa-IR');
                    }
                },
                { 
                    data: 'delivery_date', 
                    title: 'ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„',
                    render: function(data) {
                        return data ? new Date(data).toLocaleDateString('fa-IR') : '---';
                    }
                },
                { data: 'delivery_location', title: 'Ù…Ø­Ù„ ØªØ­ÙˆÛŒÙ„' },
                { data: 'supplier', title: 'Ø¹Ø±Ø¶Ù‡â€ŒÚ©Ù†Ù†Ø¯Ù‡' },
                { 
                    data: 'settlement_date', 
                    title: 'ØªØ§Ø±ÛŒØ® ØªØ³ÙˆÛŒÙ‡',
                    render: function(data) {
                        return data ? new Date(data).toLocaleDateString('fa-IR') : '---';
                    }
                },
                { data: 'broker', title: 'Ú©Ø§Ø±Ú¯Ø²Ø§Ø±' },
                { data: 'supply_method', title: 'Ø±ÙˆØ´ Ø¹Ø±Ø¶Ù‡' },
                { data: 'purchase_method', title: 'Ø±ÙˆØ´ Ø®Ø±ÛŒØ¯' },
                { 
                    data: 'packaging', 
                    title: 'Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ',
                    render: function(data) {
                        return data === null ? '---' : data;
                    }
                },
                { 
                    data: 'settlement_type', 
                    title: 'Ù†ÙˆØ¹ ØªØ³ÙˆÛŒÙ‡',
                    render: function(data) {
                        return data === null ? '---' : data;
                    }
                },
                { data: 'currency', title: 'ÙˆØ§Ø­Ø¯ Ù¾ÙˆÙ„' },
                { data: 'supply_code', title: 'Ú©Ø¯ Ø¹Ø±Ø¶Ù‡' }
            ],
            language: {
                search: "Ø¬Ø³ØªØ¬Ùˆ:",
                lengthMenu: "Ù†Ù…Ø§ÛŒØ´ _MENU_ Ø³Ø·Ø±",
                info: "Ù†Ù…Ø§ÛŒØ´ _START_ ØªØ§ _END_ Ø§Ø² _TOTAL_ Ø³Ø·Ø±",
                infoEmpty: "Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯",
                infoFiltered: "(ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡ Ø§Ø² _MAX_ Ø³Ø·Ø±)",
                paginate: {
                    first: "Ø§ÙˆÙ„",
                    last: "Ø¢Ø®Ø±",
                    next: "Ø¨Ø¹Ø¯ÛŒ",
                    previous: "Ù‚Ø¨Ù„ÛŒ"
                }
            },
            order: [[0, 'desc']],
            pageLength: 25,
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'copy',
                    text: 'Ú©Ù¾ÛŒ'
                },
                {
                    extend: 'csv',
                    text: 'Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV'
                },
                {
                    extend: 'excel',
                    text: 'Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel'
                },
                {
                    extend: 'print',
                    text: 'Ú†Ø§Ù¾'
                }
            ],
            responsive: true,
            scrollX: true
        });
    }

    function updateFilterSummary() {
    const summaryDiv = document.getElementById("filterSummary");
    const selectedFiltersDiv = document.querySelector(".selected-filters");
    let summaryText = "";

    if (currentFilters.market) {
        summaryText += `<span>ØªØ§Ù„Ø§Ø±: ${currentFilters.market}</span>`;
    }
    if (currentFilters.producer) {
        summaryText += `<span>ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡: ${currentFilters.producer}</span>`;
    }
    if (currentFilters.product) {
        summaryText += `<span>Ù…Ø­ØµÙˆÙ„: ${currentFilters.product}</span>`;
    }
    if (currentFilters.contractType) {
        summaryText += `<span>Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: ${currentFilters.contractType}</span>`;
    }
    if (currentFilters.chartType) {
        summaryText += `<span>Ù†ÙˆØ¹ Ù†Ù…ÙˆØ¯Ø§Ø±: ${currentFilters.chartType === 'candlestick' ? 'Ø´Ù…Ø¹ÛŒ' : 'Ø®Ø·ÛŒ'}</span>`;
    }

    summaryDiv.innerHTML = summaryText || "Ù‡ÛŒÚ† ÙÛŒÙ„ØªØ±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª";

    if (summaryText) {
        selectedFiltersDiv.style.display = "block";
    } else {
        selectedFiltersDiv.style.display = "none";
    }
    }

    // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    $(document).ready(function() {
      // ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ
      const currentDateTime = "2025-02-21 07:59:06";
      const currentUser = "AmirMohammadSalimi";
      
      // ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡
      document.getElementById("lastUpdate").textContent = new Date(currentDateTime).toLocaleString("fa-IR");
      document.getElementById("currentUser").textContent = currentUser;

      // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Select2 Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ÙÛŒÙ„ØªØ±Ù‡Ø§
      initializeSelect2();
      
      // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØªØ§Ù„Ø§Ø±Ù‡Ø§
      loadMarkets();
      
      // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆØ¯Ø§Ø±
      createChart();

      // Ø§ØªØµØ§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§
      $("#marketFilter").on("change", handleMarketChange);
      $("#producerFilter").on("change", handleProducerChange);
      $("#productFilter").on("change", handleProductChange);
      $("#contractTypeFilter").on("change", handleContractTypeChange);
      $("#chartTypeFilter").on("change", handleChartTypeChange);

      // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ú©Ù…Ù‡ Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
      $("#applyFilters").on("click", async function() {
        showLoading();
        try {
            const url = new URL("http://185.213.164.220:8000/markets/data");
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø¨Ù‡ URL
            if (currentFilters.market) url.searchParams.append("market", currentFilters.market);
            if (currentFilters.producer) url.searchParams.append("producer", currentFilters.producer);
            if (currentFilters.product) url.searchParams.append("product_name", currentFilters.product);
            if (currentFilters.contractType) url.searchParams.append("contract_type", currentFilters.contractType);

            console.log("Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§:", url.toString());

            const response = await fetch(url);
            const data = await response.json();

            if (data && data.filtered_data) {
            rawData = data.filtered_data;
            updateChart(rawData);
            showDataTable(rawData);
            updateFilterSummary(); // Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: ÙˆÙ‚ØªÛŒ Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯
            } else {
            chart.showLoading('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
            document.getElementById("dataTableContainer").style.display = "none";
            updateFilterSummary(); // Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: ÙˆÙ‚ØªÛŒ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª
            }
        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø±:", error);
            chart.showLoading('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
            updateFilterSummary(); // Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: ÙˆÙ‚ØªÛŒ Ø®Ø·Ø§ Ø±Ø® Ø¯Ø§Ø¯
        } finally {
            hideLoading();
            chart.hideLoading(); // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ù†Ù…ÙˆØ¯Ø§Ø±
        }
        });

      // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„
      $("#toggleTable").on("click", function() {
          const tableContainer = document.getElementById("dataTableContainer");
          const button = document.getElementById("toggleTable");
          if (tableContainer.style.visibility === "hidden" || tableContainer.style.visibility === "") {
              tableContainer.style.visibility = "visible";
              tableContainer.style.position = "static";
              tableContainer.style.left = "auto";
              button.textContent = "Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª";
              if (rawData.length > 0) {
                  showDataTable(rawData);
              }
              if (chart) {
                  setTimeout(() => chart.reflow(), 100);
              }
          } else {
              tableContainer.style.visibility = "hidden";
              tableContainer.style.position = "absolute";
              tableContainer.style.left = "-9999px";
              button.textContent = "Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª";
              if (chart) {
                  setTimeout(() => chart.reflow(), 100);
              }
          }
      });

      // Ø§Ø¹Ù…Ø§Ù„ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Select2
      $(".select2-container").css({
          "width": "100%",
          "font-family": "Vazirmatn"
      });

      // ØªÙ†Ø¸ÛŒÙ… Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¬Ø¯ÙˆÙ„
      $("#dataTableContainer").hide();

      // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø¯Ø± ØµÙˆØ±Øª Ø±ÙØ±Ø´ ØµÙØ­Ù‡
      resetFilters();

      // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ø§ÙˆÙ„ÛŒÙ‡
      hideLoading();

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
      window.onerror = function(msg, url, line) {
          console.error("Ø®Ø·Ø§ÛŒ JavaScript:", msg, "Ø¯Ø± Ø®Ø·", line, "Ø§Ø² ÙØ§ÛŒÙ„", url);
          hideLoading();
          return false;
      };

      // Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡
      window.addEventListener('offline', function() {
          alert('Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù‚Ø·Ø¹ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.');
      });

      // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± (Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡)
      setInterval(function() {
          if (currentFilters.market) {
              $("#applyFilters").trigger("click");
          }
      }, 300000); // 5 Ø¯Ù‚ÛŒÙ‚Ù‡

      console.log("ğŸš€ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯");
  });
    </script>
  </body>
</html>
